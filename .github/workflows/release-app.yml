name: Release App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0-beta.1)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (build without releasing)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Windows Build
  # ============================================================================
  build-windows:
    name: Build (Windows x64)
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            apps/desktop/src-tauri -> apps/desktop/src-tauri/target

      - name: Setup OpenCASCADE
        shell: powershell
        run: .\scripts\occt\setup.ps1

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build App
        shell: powershell
        env:
          OCCT_ROOT: ${{ github.workspace }}\deps\occt-7.9.2
          DEP_OCCT_ROOT: ${{ github.workspace }}\deps\occt-7.9.2
          CASROOT: ${{ github.workspace }}\deps\occt-7.9.2
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: .\scripts\dev\run-with-occt.ps1 "bun run --filter @cadhy/desktop tauri:build"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe.sig
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi.sig
          if-no-files-found: error

  # ============================================================================
  # macOS Build (Apple Silicon only for now - x64 cross-compilation requires x64 runner)
  # ============================================================================
  build-macos:
    name: Build (macOS ${{ matrix.arch }})
    runs-on: macos-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          # Temporarily disabled: x64 cross-compilation fails on ARM runners
          # - target: x86_64-apple-darwin
          #   arch: x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            apps/desktop/src-tauri -> apps/desktop/src-tauri/target

      - name: Install OpenCASCADE via Homebrew
        run: |
          brew install opencascade
          echo "OCCT installed at: $(brew --prefix opencascade)"

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Import Apple Certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -n "$APPLE_CERTIFICATE" ]; then
            echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
            security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security set-keychain-settings -t 3600 -u build.keychain
            security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
            rm certificate.p12
          else
            echo "No Apple certificate provided, skipping code signing setup"
          fi

      - name: Build App
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          bun run --filter @cadhy/desktop tauri:build:macos -- --target ${{ matrix.target }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries-${{ matrix.arch }}
          path: |
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg.sig
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
          if-no-files-found: warn

  # ============================================================================
  # Linux Build (may fail - Ubuntu OCCT packages are v7.5, we need v7.9.2 features)
  # ============================================================================
  build-linux:
    name: Build (Linux x64)
    runs-on: ubuntu-22.04
    continue-on-error: true  # Don't block release if Linux fails
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libocct-foundation-dev \
            libocct-modeling-algorithms-dev \
            libocct-modeling-data-dev \
            libocct-data-exchange-dev \
            libocct-visualization-dev

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-gnu

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            apps/desktop/src-tauri -> apps/desktop/src-tauri/target

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build App
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: bun run --filter @cadhy/desktop tauri:build

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: |
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage.sig
          if-no-files-found: warn

  # ============================================================================
  # Create GitHub Release with Update Manifest
  # ============================================================================
  release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    # Run if at least macOS arm64 OR Windows succeeded (allow partial releases)
    if: |
      always() &&
      startsWith(github.ref, 'refs/tags/v') &&
      github.event.inputs.dry_run != 'true' &&
      (needs.build-macos.result == 'success' || needs.build-windows.result == 'success')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -laR artifacts/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(awk "/## \[${VERSION}\]/{flag=1; next} /## \[/{flag=0} flag" CHANGELOG.md)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="Release v${VERSION}"
            fi
          else
            CHANGELOG="Release v${VERSION}"
          fi
          echo "$CHANGELOG" > changelog_body.txt
          echo "changelog_file=changelog_body.txt" >> $GITHUB_OUTPUT

      - name: Generate update manifest (latest.json)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASES_REPO="crhistian-cornejo/cadhy-releases"

          # Build platforms object dynamically based on available artifacts
          PLATFORMS="{"
          FIRST=true

          # macOS arm64
          if ls artifacts/macos-binaries-arm64/*.app.tar.gz.sig 2>/dev/null; then
            SIG=$(cat artifacts/macos-binaries-arm64/*.app.tar.gz.sig)
            if [ "$FIRST" = false ]; then PLATFORMS+=","; fi
            PLATFORMS+="\"darwin-aarch64\":{\"signature\":\"$SIG\",\"url\":\"https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_aarch64.app.tar.gz\"}"
            FIRST=false
          fi

          # macOS x64 (if built)
          if ls artifacts/macos-binaries-x64/*.app.tar.gz.sig 2>/dev/null; then
            SIG=$(cat artifacts/macos-binaries-x64/*.app.tar.gz.sig)
            if [ "$FIRST" = false ]; then PLATFORMS+=","; fi
            PLATFORMS+="\"darwin-x86_64\":{\"signature\":\"$SIG\",\"url\":\"https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_x64.app.tar.gz\"}"
            FIRST=false
          fi

          # Linux
          if ls artifacts/linux-binaries/*.AppImage.sig 2>/dev/null; then
            SIG=$(cat artifacts/linux-binaries/*.AppImage.sig)
            if [ "$FIRST" = false ]; then PLATFORMS+=","; fi
            PLATFORMS+="\"linux-x86_64\":{\"signature\":\"$SIG\",\"url\":\"https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_amd64.AppImage\"}"
            FIRST=false
          fi

          # Windows
          if ls artifacts/windows-binaries/*.exe.sig 2>/dev/null; then
            SIG=$(cat artifacts/windows-binaries/*.exe.sig)
            if [ "$FIRST" = false ]; then PLATFORMS+=","; fi
            PLATFORMS+="\"windows-x86_64\":{\"signature\":\"$SIG\",\"url\":\"https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_x64-setup.exe\"}"
            FIRST=false
          fi

          PLATFORMS+="}"

          cat > artifacts/latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See the release notes at https://github.com/${RELEASES_REPO}/releases/tag/v${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": ${PLATFORMS}
          }
          EOF
          echo "Generated latest.json:"
          cat artifacts/latest.json

      - name: Create Release on cadhy-releases Repo
        uses: softprops/action-gh-release@v2
        with:
          repository: crhistian-cornejo/cadhy-releases
          tag_name: v${{ steps.version.outputs.version }}
          name: CADHY v${{ steps.version.outputs.version }}
          body_path: changelog_body.txt
          files: |
            artifacts/windows-binaries/**/*
            artifacts/macos-binaries-arm64/**/*
            artifacts/macos-binaries-x64/**/*
            artifacts/linux-binaries/**/*
            artifacts/latest.json
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASES_TOKEN }}
